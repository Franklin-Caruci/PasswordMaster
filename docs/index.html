<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Password Master V1.2 - Pro Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <script>
        const CLIENT_ID = '333415357306-m0gdg683did4ci4l1i74hga0vgcnblbp.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyBy6D75us4mmH9hM14rCbg_56Vz0YVtc00';
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        let tokenClient, gapiInited = false, gisInited = false;

        function gapiLoaded() {
            gapi.load('client', async () => {
                await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS });
                gapiInited = true;
            });
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', 
            });
            gisInited = true;
        }
    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #0f172a; color: #f1f5f9; }
        .bg-glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .modal { transition: opacity 0.2s; opacity: 0; visibility: hidden; pointer-events: none; position: fixed; inset: 0; z-index: 1000; }
        .modal.active { opacity: 1; visibility: visible; pointer-events: auto; }
        .sync-pulse { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
    </style>
</head>
<body class="pb-20">

    <div id="toast-container"></div>

    <div id="lockScreen" class="fixed inset-0 z-[2000] bg-slate-900 flex items-center justify-center p-6 text-center">
        <div class="max-w-md w-full space-y-6">
            <h1 class="text-3xl font-black italic text-indigo-400 uppercase tracking-tighter">B√≥veda de Seguridad</h1>
            <p class="text-slate-400 text-[10px] uppercase font-bold tracking-[0.2em]">Cifrado AES-256 Activado</p>
            <input type="password" id="masterKeyInput" placeholder="Ingrese su Llave Maestra..." class="w-full p-5 bg-slate-800 rounded-3xl border-none ring-1 ring-slate-700 text-center font-black text-xl outline-none focus:ring-2 focus:ring-indigo-500">
            <button onclick="app.unlock()" class="w-full bg-indigo-600 p-5 rounded-3xl font-black uppercase shadow-xl hover:bg-indigo-500 transition-all">Desbloquear</button>
        </div>
    </div>

    <header class="bg-slate-900/80 backdrop-blur-md p-5 sticky top-0 z-50 border-b border-slate-800">
        <div class="max-w-5xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4">
                <div>
                    <h1 class="text-xl font-black italic uppercase text-indigo-400 tracking-tighter">P-Master <span class="text-white text-[10px]">V1.2</span></h1>
                    <div id="cloudStatus" class="flex items-center gap-2 mt-1">
                        <div id="statusDot" class="w-2 h-2 bg-rose-500 rounded-full"></div>
                        <span id="statusText" class="text-[7px] font-black uppercase text-slate-500">Modo Local</span>
                    </div>
                </div>
            </div>
            
            <div class="flex flex-wrap justify-center gap-2">
                <button onclick="app.exportVault()" class="bg-slate-800 hover:bg-slate-700 text-white px-3 py-2 rounded-xl font-bold text-[9px] uppercase border border-slate-700 transition-all">Exportar</button>
                <label class="cursor-pointer bg-slate-800 hover:bg-slate-700 text-white px-3 py-2 rounded-xl font-bold text-[9px] uppercase border border-slate-700 flex items-center transition-all">
                    <span>Importar</span>
                    <input type="file" id="importFile" class="hidden" accept=".json" onchange="app.importVault(event)">
                </label>
                
                <div class="w-px h-8 bg-slate-800 mx-1 hidden md:block"></div>

                <button id="btnSyncDrive" class="p-2.5 bg-white/10 rounded-2xl hover:bg-indigo-600 transition-all">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M21.3 14.5l-6.3-11c-.3-.5-.9-.8-1.5-.8H6.5c-.6 0-1.2.3-1.5.8L.7 14.5c-.3.5-.3 1.1 0 1.6l3.2 5.5c.3.5.9.8 1.5.8h13.1c.6 0 1.2-.3 1.5-.8l3.2-5.5c.4-.5.4-1.1.1-1.6zm-14.8 5.4l-1.6-2.8 4.7-8.1 1.6 2.8-4.7 8.1zm10.7 0H7.7l4.7-8.1 9.5 0-4.7 8.1zm-1.6-11l-4.7-8.1 3.2 0 4.7 8.1-3.2 0z"/></svg>
                </button>
                <button onclick="app.toggleModal(true)" class="bg-indigo-600 px-5 py-2.5 rounded-2xl font-black text-[10px] uppercase shadow-lg shadow-indigo-500/20 hover:bg-indigo-500 transition-all">+ Nueva</button>
            </div>
        </div>
    </header>

    <main class="max-w-5xl mx-auto p-4 md:p-8 space-y-6">
        <div class="relative group">
            <input type="text" id="searchInput" oninput="app.render()" placeholder="Buscar por dispositivo, usuario o nivel..." class="w-full p-5 bg-slate-800 rounded-[2rem] border-none ring-1 ring-slate-700 outline-none focus:ring-2 focus:ring-indigo-500 font-bold transition-all shadow-xl">
            <span class="absolute right-6 top-5 opacity-20 group-focus-within:opacity-100 transition-opacity">üîç</span>
        </div>

        <div id="passwordList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    </main>

    <div id="entryModal" class="modal flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-950/90 backdrop-blur-sm" onclick="app.toggleModal(false)"></div>
        <div class="bg-slate-900 w-full max-w-md rounded-[3rem] shadow-2xl z-[1001] relative p-8 border border-slate-800">
            <h3 id="modalTitle" class="text-xl font-black uppercase mb-6 italic text-indigo-400">Registrar Credencial</h3>
            <form id="entryForm" class="space-y-4">
                <input type="hidden" id="editId">
                <div class="flex flex-col gap-1">
                    <label class="text-[9px] font-black text-slate-500 uppercase ml-2">Nivel / Grupo</label>
                    <select id="inputLevel" class="w-full p-4 bg-slate-800 rounded-2xl border-none ring-1 ring-slate-700 outline-none focus:ring-2 focus:ring-indigo-500 font-bold text-sm">
                        <option value="PERSONAL">Personal</option>
                        <option value="TRABAJO">Trabajo</option>
                        <option value="DISPOSITIVOS">Dispositivos / Red</option>
                        <option value="BANCOS">Financiero</option>
                        <option value="OTROS">Otros</option>
                    </select>
                </div>
                <div class="flex flex-col gap-1">
                    <label class="text-[9px] font-black text-slate-500 uppercase ml-2">Nombre o Dispositivo</label>
                    <input type="text" id="inputAccount" required class="w-full p-4 bg-slate-800 rounded-2xl border-none ring-1 ring-slate-700 outline-none focus:ring-2 focus:ring-indigo-500 font-bold text-sm">
                </div>
                <div class="flex flex-col gap-1">
                    <label class="text-[9px] font-black text-slate-500 uppercase ml-2">ID / Usuario / Correo</label>
                    <input type="text" id="inputUser" required class="w-full p-4 bg-slate-800 rounded-2xl border-none ring-1 ring-slate-700 outline-none focus:ring-2 focus:ring-indigo-500 font-bold text-sm">
                </div>
                <div class="flex flex-col gap-1">
                    <label class="text-[9px] font-black text-slate-500 uppercase ml-2">Password / Contrase√±a</label>
                    <input type="text" id="inputPass" required class="w-full p-4 bg-slate-800 rounded-2xl border-none ring-1 ring-slate-700 outline-none focus:ring-2 focus:ring-indigo-500 font-bold text-sm">
                </div>
                <button type="submit" id="btnSubmit" class="w-full bg-indigo-600 text-white font-black py-5 rounded-3xl text-xs uppercase shadow-xl mt-4 hover:bg-indigo-500 transition-all">Guardar en B√≥veda</button>
            </form>
        </div>
    </div>

    <script>
        const DB = {
            key: 'pmaster_v1_1_data', // Conservamos la misma clave para que tus datos sigan ah√≠
            masterKey: '',
            save(data) {
                const encrypted = CryptoJS.AES.encrypt(JSON.stringify(data), this.masterKey).toString();
                localStorage.setItem(this.key, encrypted);
                if(gapi.client?.getToken()) app.syncToDrive(encrypted);
            },
            load() {
                const d = localStorage.getItem(this.key);
                if(!d) return [];
                try {
                    const bytes = CryptoJS.AES.decrypt(d, this.masterKey);
                    return JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
                } catch(e) { return null; }
            }
        };

        const app = {
            vault: [],
            driveFileId: null,

            unlock() {
                const key = document.getElementById('masterKeyInput').value;
                if(!key) return;
                DB.masterKey = key;
                const data = DB.load();
                if(data === null && localStorage.getItem(DB.key)) {
                    this.notify("Llave Maestra incorrecta", "error");
                } else {
                    this.vault = data || [];
                    document.getElementById('lockScreen').style.display = 'none';
                    this.render();
                    this.notify("B√≥veda Abierta", "success");
                }
            },

            async handleAuth() {
                tokenClient.callback = async (resp) => {
                    if (resp.error !== undefined) throw (resp);
                    this.updateStatus(true);
                    await this.loadFromDrive();
                };
                tokenClient.requestAccessToken({prompt: gapi.client.getToken() === null ? 'consent' : ''});
            },

            async syncToDrive(content) {
                try {
                    document.getElementById('statusDot').classList.add('sync-pulse');
                    if (this.driveFileId) {
                        await gapi.client.request({ path: '/upload/drive/v3/files/' + this.driveFileId, method: 'PATCH', params: { uploadType: 'media' }, body: content });
                    } else {
                        const metadata = { name: 'password_master_vault.enc', mimeType: 'text/plain' };
                        const form = new FormData();
                        form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
                        form.append('file', new Blob([content], {type: 'text/plain'}));
                        const resp = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                            method: 'POST', headers: new Headers({ 'Authorization': 'Bearer ' + gapi.client.getToken().access_token }), body: form
                        });
                        const res = await resp.json(); this.driveFileId = res.id;
                    }
                    setTimeout(() => document.getElementById('statusDot').classList.remove('sync-pulse'), 1000);
                } catch (e) { console.error(e); }
            },

            async loadFromDrive() {
                const resp = await gapi.client.drive.files.list({ q: "name = 'password_master_vault.enc' and trashed = false" });
                if (resp.result.files.length > 0) {
                    this.driveFileId = resp.result.files[0].id;
                    const file = await gapi.client.drive.files.get({ fileId: this.driveFileId, alt: 'media' });
                    localStorage.setItem(DB.key, file.body);
                    const data = DB.load();
                    if(data) { this.vault = data; this.render(); this.notify("Datos de Nube Sincronizados"); }
                }
            },

            handleForm() {
                const editId = document.getElementById('editId').value;
                const entry = {
                    id: editId ? parseInt(editId) : Date.now(),
                    level: document.getElementById('inputLevel').value,
                    account: document.getElementById('inputAccount').value,
                    user: document.getElementById('inputUser').value,
                    pass: document.getElementById('inputPass').value
                };

                if(editId) {
                    const idx = this.vault.findIndex(v => v.id === entry.id);
                    if(idx !== -1) this.vault[idx] = entry;
                } else {
                    this.vault.push(entry);
                }

                DB.save(this.vault);
                this.render();
                this.toggleModal(false);
                this.notify(editId ? "Credencial actualizada" : "Credencial guardada");
            },

            startEdit(id) {
                const entry = this.vault.find(v => v.id === id);
                if(!entry) return;

                document.getElementById('modalTitle').innerText = "Editar Credencial";
                document.getElementById('editId').value = entry.id;
                document.getElementById('inputLevel').value = entry.level;
                document.getElementById('inputAccount').value = entry.account;
                document.getElementById('inputUser').value = entry.user;
                document.getElementById('inputPass').value = entry.pass;
                document.getElementById('btnSubmit').innerText = "Actualizar B√≥veda";
                
                this.toggleModal(true);
            },

            exportVault() {
                const data = JSON.stringify(this.vault, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `PMaster_Backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                this.notify("Respaldo descargado");
            },

            importVault(event) {
                const file = event.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const imported = JSON.parse(e.target.result);
                        if(Array.isArray(imported)) {
                            if(confirm("¬øDesea combinar los datos importados con los actuales? (Cancelar para reemplazarlos)")) {
                                this.vault = [...this.vault, ...imported];
                            } else {
                                this.vault = imported;
                            }
                            DB.save(this.vault);
                            this.render();
                            this.notify("Datos importados con √©xito");
                        }
                    } catch(err) { this.notify("Error al leer el archivo", "error"); }
                };
                reader.readAsText(file);
            },

            render() {
                const search = document.getElementById('searchInput').value.toLowerCase();
                const list = document.getElementById('passwordList');
                const filtered = this.vault.filter(i => 
                    i.account.toLowerCase().includes(search) || 
                    i.user.toLowerCase().includes(search) ||
                    i.level.toLowerCase().includes(search)
                ).sort((a,b) => a.level.localeCompare(b.level));

                list.innerHTML = filtered.map(i => `
                    <div class="bg-glass p-6 rounded-[2.5rem] card-shadow flex justify-between items-center border border-slate-800/50 hover:border-indigo-500/50 transition-all">
                        <div class="space-y-1">
                            <span class="text-[7px] font-black uppercase tracking-widest text-indigo-400 bg-indigo-500/10 px-2 py-1 rounded-lg">${i.level}</span>
                            <h4 class="font-black text-base text-white mt-1">${i.account}</h4>
                            <p class="text-[11px] text-slate-400 font-bold">ID: <span class="text-indigo-200">${i.user}</span></p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="app.copy('${i.pass}')" class="p-3 bg-slate-800 rounded-2xl hover:bg-indigo-600 transition-all text-[9px] font-black uppercase tracking-tighter">Copiar</button>
                            <button onclick="app.startEdit(${i.id})" class="p-3 bg-slate-800 rounded-2xl hover:bg-emerald-600 transition-all text-sm">‚úé</button>
                            <button onclick="app.deleteItem(${i.id})" class="text-slate-600 hover:text-rose-500 p-2 text-xl font-bold transition-colors">‚úï</button>
                        </div>
                    </div>
                `).join('');
            },

            copy(text) {
                navigator.clipboard.writeText(text);
                this.notify("Password copiado");
            },

            deleteItem(id) {
                if(confirm("¬øEliminar credencial definitivamente?")) {
                    this.vault = this.vault.filter(i => i.id !== id);
                    DB.save(this.vault);
                    this.render();
                }
            },

            updateStatus(on) {
                const dot = document.getElementById('statusDot');
                const text = document.getElementById('statusText');
                dot.className = on ? 'w-2 h-2 bg-emerald-500 rounded-full' : 'w-2 h-2 bg-rose-500 rounded-full';
                text.innerText = on ? 'B√≥veda Sincronizada' : 'Modo Local';
            },

            toggleModal(s) { 
                if(!s) {
                    document.getElementById('entryForm').reset();
                    document.getElementById('editId').value = '';
                    document.getElementById('modalTitle').innerText = "Registrar Credencial";
                    document.getElementById('btnSubmit').innerText = "Guardar en B√≥veda";
                }
                document.getElementById('entryModal').classList.toggle('active', s); 
            },

            notify(m, type="success") { 
                const c = document.getElementById('toast-container'); const t = document.createElement('div');
                t.className = `${type==='success'?'bg-indigo-600':'bg-rose-600'} text-white px-6 py-3 rounded-2xl font-bold text-[10px] fixed bottom-10 right-10 shadow-2xl z-[2000] uppercase tracking-widest`;
                t.innerText = m; c.appendChild(t); setTimeout(() => t.remove(), 2500); 
            }
        };

        window.onload = () => {
            document.getElementById('btnSyncDrive').onclick = () => app.handleAuth();
            document.getElementById('entryForm').onsubmit = (e) => { e.preventDefault(); app.handleForm(); };
        };
    </script>
</body>
</html>
